Contribution by alexdaube and JulienDuchesne.
